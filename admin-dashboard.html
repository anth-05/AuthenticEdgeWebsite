<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | AuthenticEdge</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="dashboard-body">
  <div class="dashboard-container">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <h2 class="sidebar-logo">AuthenticEdge</h2>
      <ul class="sidebar-menu">
        <li><a href="admin-products.html">Products Management</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="shop.html">Products</a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="dashboard-main">
      <header class="dashboard-header">
        <h1>Admin Dashboard</h1>
        <p id="welcome-message">Loading...</p>
      </header>

      <!-- ===== STATS ===== -->
      <section class="analytics" id="analytics">
        <div class="card">
          <h3>Total Users</h3>
          <p id="user-count">Loading...</p>
        </div>

        <div class="card">
          <h3>Admins</h3>
          <p id="admin-count">Loading...</p>
        </div>

        <div class="card">
          <h3>Regular Users</h3>
          <p id="regular-count">Loading...</p>
        </div>
      </section>

      <!-- ===== RECENT USERS ===== -->
      <section class="activity">
        <div class="card full-width">
          <h3>Recent Users</h3>
          <table class="user-table" id="recent-users">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="3">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ===== MANAGE USERS ===== -->
      <section class="manage-users">
        <div class="card full-width">
          <h3>Manage Users</h3>
          <table class="user-table" id="all-users">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
      // üåç Detect backend URL automatically
  const API_BASE_URL =
    window.location.hostname === "localhost"
      ? "http://localhost:5000"
      : "https://your-backend-name.onrender.com"; // üîÅ replace with your real Render backend URL

  document.addEventListener("DOMContentLoaded", loadDashboard);

  async function loadDashboard() {
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    if (!token || role !== "admin") {
      alert("Access denied! Admins only.");
      window.location.href = "login.html";
      return;
    }

    // ‚úÖ Verify session
    const verify = await fetch(`${API_BASE_URL}/api/protected`, {
      headers: { Authorization: "Bearer " + token }
    });

    if (!verify.ok) {
      alert("Session expired. Please log in again.");
      logout();
      return;
    }

    const verifyData = await verify.json();
    document.getElementById("welcome-message").textContent =
      `Welcome, ${verifyData.user.email} (${verifyData.user.role})`;

    // ‚úÖ Fetch stats (authenticated)
    const statsRes = await fetch(`${API_BASE_URL}/api/stats`, {
      headers: { Authorization: "Bearer " + token }
    });
    const statsData = await statsRes.json();

    document.getElementById("user-count").textContent = statsData.users;
    document.getElementById("admin-count").textContent = statsData.admins;
    document.getElementById("regular-count").textContent = statsData.regularUsers;

    // ‚úÖ Fetch all users
    const usersRes = await fetch(`${API_BASE_URL}/api/users`, {
      headers: { Authorization: "Bearer " + token }
    });
    const users = await usersRes.json();

    renderRecentUsers(users);
    renderAllUsers(users);
  }

  function renderRecentUsers(users) {
    const recentTbody = document.querySelector("#recent-users tbody");
    recentTbody.innerHTML = "";

    const recent = users.slice(0, 5);
    recent.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td>${new Date(u.created_at).toLocaleString()}</td>
      `;
      recentTbody.appendChild(tr);
    });
  }

  function renderAllUsers(users) {
    const manageTbody = document.querySelector("#all-users tbody");
    manageTbody.innerHTML = "";

    users.forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.email}</td>
        <td>
          <select onchange="updateUserRole(${u.id}, this.value)">
            <option value="user" ${u.role === "user" ? "selected" : ""}>User</option>
            <option value="admin" ${u.role === "admin" ? "selected" : ""}>Admin</option>
          </select>
        </td>
        <td><button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button></td>
      `;
      manageTbody.appendChild(tr);
    });
  }

  async function updateUserRole(id, role) {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/users/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ role })
    });

    if (res.ok) {
      alert("‚úÖ User role updated successfully!");
      loadDashboard();
    } else {
      alert("‚ùå Failed to update user role.");
    }
  }

  async function deleteUser(id) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/users/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    });

    if (res.ok) {
      alert("üóëÔ∏è User deleted!");
      loadDashboard();
    } else {
      alert("‚ùå Failed to delete user.");
    }
  }

  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }
  </script>
</body>
</html>
