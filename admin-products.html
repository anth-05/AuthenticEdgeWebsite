<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Products | AuthenticEdge Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="dashboard-body">
  <div class="dashboard-container">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <h2 class="sidebar-logo">AuthenticEdge</h2>
      <ul class="sidebar-menu">
        <li><a href="admin-dashboard.html">Dashboard</a></li>
        <li><a href="admin-products.html" class="active">Products Management</a></li>
        <li><a href="shop.html">Products</a></li>
        <li><a href="index.html">Home</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="dashboard-main">
      <header class="dashboard-header">
        <h1>Product Management</h1>
        <p id="welcome-message">Loading...</p>
      </header>

      <!-- ===== ADD PRODUCT FORM ===== -->
      <section class="add-product card full-width">
        <h3>Add New Product</h3>
        <form id="add-product-form">
          <div class="form-row">
            <input type="text" id="name" placeholder="Product Name" required />
            <input type="text" id="image" placeholder="Image URL" required />
          </div>

          <div class="form-row">
            <input type="text" id="gender" placeholder="Gender (e.g., Men, Women, Unisex)" />
            <input type="text" id="quality" placeholder="Quality (e.g., Premium, Better, Classic)" />
          </div>

          <div class="form-row">
            <input type="text" id="availability" placeholder="Availability (e.g., In Stock, Out of Stock)" />
          </div>

          <textarea id="description" placeholder="Product Description" rows="3"></textarea>

          <button type="submit" class="btn">Add Product</button>
        </form>
      </section>

      <!-- ===== PRODUCT LIST ===== -->
      <section class="manage-products">
        <div class="card full-width">
          <h3>All Products</h3>
          <table class="user-table" id="product-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Image</th>
                <th>Name</th>
                <th>Gender</th>
                <th>Quality</th>
                <th>Availability</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== SCRIPT ===== -->
<script>
  // üåç Auto-detect backend
  const API_BASE_URL =
    window.location.hostname === "localhost"
      ? "http://localhost:5000"
      : "https://your-backend-name.onrender.com"; // üîÅ replace with your actual Render backend URL

  document.addEventListener("DOMContentLoaded", initProductsPage);

  async function initProductsPage() {
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");

    // üîê Verify admin
    if (!token || role !== "admin") {
      alert("Access denied! Admins only.");
      window.location.href = "login.html";
      return;
    }

    // ‚úÖ Verify session
    const verify = await fetch(`${API_BASE_URL}/api/protected`, {
      headers: { Authorization: "Bearer " + token }
    });

    if (!verify.ok) {
      alert("Session expired. Please log in again.");
      logout();
      return;
    }

    const verifyData = await verify.json();
    document.getElementById("welcome-message").textContent =
      `Welcome, ${verifyData.user.email} (${verifyData.user.role})`;

    loadProducts();
  }

  // ===== Load all products =====
  async function loadProducts() {
    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/products`, {
      headers: { Authorization: "Bearer " + token }
    });

    const products = await res.json();
    const tbody = document.querySelector("#product-table tbody");
    tbody.innerHTML = "";

    products.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td><img src="${p.image}" alt="${p.name}" class="product-thumb"></td>
        <td>${p.name}</td>
        <td>${p.gender || "-"}</td>
        <td>${p.quality || "-"}</td>
        <td>${p.availability || "-"}</td>
        <td>
          <button class="edit-btn" onclick="editProduct(${p.id})">Edit</button>
          <button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== Add new product =====
  document.getElementById("add-product-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("token");
    const data = {
      name: document.getElementById("name").value.trim(),
      description: document.getElementById("description").value.trim(),
      image: document.getElementById("image").value.trim(),
      gender: document.getElementById("gender").value.trim(),
      quality: document.getElementById("quality").value.trim(),
      availability: document.getElementById("availability").value.trim(),
    };

    const res = await fetch(`${API_BASE_URL}/api/products`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify(data)
    });

    if (res.ok) {
      alert("‚úÖ Product added successfully!");
      e.target.reset();
      loadProducts();
    } else {
      alert("‚ùå Failed to add product.");
    }
  });

  // ===== Edit product =====
  async function editProduct(id) {
    const newName = prompt("Enter new product name:");
    if (!newName) return;

    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/products/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + token
      },
      body: JSON.stringify({ name: newName })
    });

    if (res.ok) {
      alert("‚úÖ Product updated!");
      loadProducts();
    } else {
      alert("‚ùå Failed to update product.");
    }
  }

  // ===== Delete product =====
  async function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;

    const token = localStorage.getItem("token");
    const res = await fetch(`${API_BASE_URL}/api/products/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token }
    });

    if (res.ok) {
      alert("üóëÔ∏è Product deleted!");
      loadProducts();
    } else {
      alert("‚ùå Failed to delete product.");
    }
  }

  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }
</script>

</body>
</html>
